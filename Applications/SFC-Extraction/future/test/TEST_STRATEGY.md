# SFC Extraction Test Strategy

## Overview

This document outlines how the test infrastructure for the SFC Extraction application is organized, including the relationships between scripts, helpers, fixtures, and test files.

**Goal**: Ensure the FHX parsing logic reliably converts `.fhx` files into correct JSON structures, detecting regressions and edge cases.

---

## Architecture

### Components

1. **Fixtures** — Static input/output data for testing
2. **Helpers** — Utility functions used by scripts and tests
3. **Scripts** — Command-line tools to generate fixtures, compare golden files, and run tests
4. **Tests** — Mocha/Chai test suites that verify parsing logic

---

## Fixtures

Fixtures are pre-defined test data stored in the `fixtures/` directory.

### Types

#### 1. Golden Fixtures (`fixtures/golden/`)

- **Purpose**: Baseline expected JSON outputs for regression testing
- **Files**: `A-PROTEIN_PROD.expected.json`
- **How Generated**: Run `scripts/update-fixtures.js` once to generate from current app
- **Usage**: Compared against current output to detect regressions
- **Commit Policy**: Commit golden fixtures to repo after manual review

#### 2. Small FHX Snippets (`fixtures/small/`)

- **Purpose**: Minimal, handcrafted FHX strings for unit tests
- **Examples**:
    - `simple_module.fhx` — `MODULE_CLASS NAME="X" { }`
    - `nested_braces.fhx` — `MODULE_CLASS NAME="Y" { INNER { KEY="v" } }`
    - `quoted_param.fhx` — Parameters with spaces in values
    - `empty_input.fhx` — Edge case: empty string
- **How Generated**: Run `scripts/generate-small-fixtures.js`
- **Usage**: Feed into `FhxUtil.findBlocks()` and `processSFC()` for fast unit tests
- **Benefit**: Fast, deterministic, isolated from large FHX files

#### 3. Failure Cases (`fixtures/failures/`) ??????

- **Purpose**: Store reproducer inputs from fuzz testing
- **Files**: Generated by `scripts/fuzz-findblocks.js` when unexpected errors occur
- **Format**: `fuzz_<timestamp>_<iteration>.fhx`
- **Usage**: Minimal test cases to debug and fix parsing bugs

---

## Helpers

Helper functions provide shared utilities for tests and scripts.

### `test/helpers/normalizeSfc.js`

**Functions**:

#### `normalizeSfc(obj)`

- Deterministic normalization for comparing SFC JSON objects
- **Steps**:
    1. Deep clone object
    2. Sort `steps[]` arrays by `id` or `name`
    3. Sort `transitions[]` arrays by `(from + to + name)`
    4. Remove volatile keys (`_generatedId`, `timestamp`, `createdAt`, `updatedAt`)
- **Why**: Ensures tests pass despite ordering differences or generated fields
- **Usage**: Called before `deep.equal()` in comparison tests

**Example**:

```javascript
const result = processSFC(fhx);
const expected = JSON.parse(goldenJson);
expect(normalizeSfc(result)).to.deep.equal(normalizeSfc(expected));
```

---

## Scripts

Scripts are command-line tools that support the test workflow. Located in `/fhxParse/scripts/`.

### 1. `update-fixtures.js`

**Purpose**: Generate golden JSON baseline from current app

**Pseudocode**:

- Load `A-PROTEIN_PROD.fhx`
- Create `PhaseLogic` and extract all 5 logic types (run, hold, abort, restart, stop)
- Call `processSFC()` on each to produce JSON
- Write to `test/fixtures/golden/A-PROTEIN_PROD.expected.json`

**When to Use**:

- Initial golden file creation
- After intentionally accepting behavior changes (with code review)

**Command**:

```bash
node scripts/update-fixtures.js
```

**Output**: `test/fixtures/golden/A-PROTEIN_PROD.expected.json`

---

### 2. `generate-small-fixtures.js`. (OPTIONAL)

**Purpose**: Create small handcrafted FHX snippets for unit tests

**Pseudocode**:

- Define array of fixtures with names and FHX content
- Write each to `test/fixtures/small/<name>.fhx`

**When to Use**:

- Initial setup
- Add new edge cases to unit test suite

**Command**:

```bash
node scripts/generate-small-fixtures.js
```

**Output**: 8 `.fhx` files in `test/fixtures/small/`

---

### 3. `compare-golden.js`

**Purpose**: Regression check — compare current output against golden baseline

**Pseudocode**:

- Load `A-PROTEIN_PROD.fhx` and run full pipeline (same as app.js)
- Load golden JSON from `test/fixtures/golden/A-PROTEIN_PROD.expected.json`
- Normalize both
- Deep-equal compare
- Exit 0 if match, 1 if mismatch

**When to Use**:

- Before commits (in CI/pre-commit hook)
- Quick regression check during development

**Command**:

```bash
node scripts/compare-golden.js
```

**Output**: Pass/fail message with diff summary

---

### 4. `normalize-json.js`

**Purpose**: CLI tool to normalize JSON files for inspection/diffs

**Pseudocode**:

- Read JSON from file (or stdin)
- Apply `normalizeSfc()` transformation
- Write to output file (or stdout)

**When to Use**:

- Debug: compare two JSON outputs
- Inspect golden file structure

**Commands**:

```bash
node scripts/normalize-json.js input.json output.json
node scripts/normalize-json.js input.json > output.json
```

---

### 5. `fuzz-findblocks.js` OPTIONAL

**Purpose**: Fuzz test `FhxUtil.findBlocks()` to find edge cases

**Pseudocode**:

- For N iterations (1000):
    - Mutate a known-good FHX string (add/remove chars, braces, quotes)
    - Try `FhxUtil.findBlocks()` on mutated input
    - If unexpected exception:
        - Save mutated input to `test/fixtures/failures/`
        - Exit with code 1
    - If expected error (EOF):
        - Count as success
- Log results

**When to Use**:

- Optional: discover edge cases automatically
- Gated by environment variable for slow runs

**Command**:

```bash
node scripts/fuzz-findblocks.js
```

**Output**: Pass/fail; failure reproducers saved to `test/fixtures/failures/`

---

### 6. `setup-test-dirs.js`

**Purpose**: Create all test folder structure

**Pseudocode**:

- For each directory (units, integration, helpers, fixtures/\*, scripts):
    - `fs.mkdir(dir, {recursive: true})`

**When to Use**:

- Initial setup (one-time)

**Command**:

```bash
node scripts/setup-test-dirs.js
```

---

### 7. `run-all-tests.js`

**Purpose**: Run all test suites in sequence with summary

**Pseudocode**:

- Run: `npm run test:fhxutil`
- Run: `npm run test:processsfc`
- Run: `npm run test:integration`
- Run: `npm run compare-golden`
- Show summary (passed/failed)

**When to Use**:

- Full test suite validation
- Pre-commit check

**Command**:

```bash
node scripts/run-all-tests.js
```

---

## Tests

Tests are Mocha/Chai test suites organized by type.

### Unit Tests

#### `test/units/fhxUtil.test.js`

**Tests**: `FhxUtil.findBlocks()` and `valueOfParameter()`

**Fixtures Used**: Small FHX snippets from `fixtures/small/`

**Tests**:

1. Extracts MODULE_CLASS block with nested braces
2. Handles missing parameters gracefully
3. Handles quoted values with spaces
4. Extracts multiple blocks of same type
5. Returns empty array for non-existent block type

**Speed**: Fast (milliseconds)

---

#### `test/units/processSfc.test.js`

**Tests**: `processSFC()` function with minimal inputs

**Fixtures Used**: Small handcrafted SFC strings (inline)

**Tests**:

1. Parses simple SFC step/transition
2. Returns object for empty input
3. Extracts step names correctly
4. Handles transitions without matching steps

**Speed**: Fast (milliseconds)

---

#### `test/units/malformed.test.js`

**Tests**: Edge cases and error handling

**Fixtures Used**: Malformed FHX strings (inline)

**Tests**:

1. Handles unbalanced braces
2. Handles empty/whitespace input
3. Handles deeply nested braces
4. processSFC returns object for malformed input

**Speed**: Fast (milliseconds)

---

### Integration Tests

#### `test/integration/sfcGolden.test.js`

**Tests**: Full pipeline with real FHX file + contract validation

**Fixtures Used**:

- Input: `Applications/SFC-Extraction/inputs/A-PROTEIN_PROD.fhx`
- Expected: `test/fixtures/golden/A-PROTEIN_PROD.expected.json`

**Tests**:

1. **Regression**: Output matches golden (normalized)
2. **Invariants**:
    - All transitions reference existing steps
    - All steps have required fields
    - All transitions have required fields
    - No duplicate step IDs

**Speed**: Slower (seconds) — uses real FHX file

**Helpers Used**: `normalizeSfc()` for comparison

---

## Workflow

### Initial Setup

```bash
# 1. Create folder structure
node scripts/setup-test-dirs.js

# 2. Generate small fixtures for unit tests
node scripts/generate-small-fixtures.js

# 3. Generate golden baseline (inspect before committing)
node scripts/update-fixtures.js
# Manually review test/fixtures/golden/A-PROTEIN_PROD.expected.json
git add test/fixtures/golden/A-PROTEIN_PROD.expected.json
```

### Development Loop

```bash
# 1. Run unit tests (fast feedback)
npm run test:fhxutil
npm run test:processsfc

# 2. Run regression check
node scripts/compare-golden.js

# 3. Run full test suite
npm run test

# 4. Optional: fuzz testing for edge cases
node scripts/fuzz-findblocks.js
```

### Accepting Changes

If behavior changes intentionally:

```bash
# 1. Verify changes are correct
npm run test

# 2. Update golden baseline
node scripts/update-fixtures.js

# 3. Commit with clear message
git add test/fixtures/golden/A-PROTEIN_PROD.expected.json
git commit -m "Update golden: [reason for change]"
```

### Adding New Test Cases

1. **For edge case**: Add small FHX snippet to `test/units/malformed.test.js`
2. **For new fixture file**:
    - Place `.fhx` in `test/fixtures/small/`
    - Reference in unit test
3. **For new golden baseline**:
    - Update `scripts/update-fixtures.js` to handle new phase/file
    - Run `node scripts/update-fixtures.js`

---

## Test Execution Matrix

| Test               | Type        | Speed | Fixtures       | Helpers      | Purpose                   |
| ------------------ | ----------- | ----- | -------------- | ------------ | ------------------------- |
| fhxUtil.test.js    | Unit        | Fast  | small/\*.fhx   | —            | Verify parsing primitives |
| processSfc.test.js | Unit        | Fast  | inline         | —            | Verify SFC extraction     |
| malformed.test.js  | Unit        | Fast  | inline         | —            | Verify error handling     |
| sfcGolden.test.js  | Integration | Slow  | golden/\*.json | normalizeSfc | Regression + invariants   |

---

## Key Principles

1. **Fast Unit Tests First**: Small snippets run in milliseconds; use for rapid feedback
2. **Golden Baseline**: One real-file test for regression detection; reviewed and committed
3. **Normalization**: Deterministic comparison ignores ordering and volatile fields
4. **Contract Tests**: Invariants (references, no duplicates) caught at integration level
5. **Fuzz Optional**: Extra validation for robustness; gated for slow CI runs
6. **Fixture Stability**: Golden files committed; small fixtures generated (not committed)

---

## Troubleshooting

### Golden Mismatch

```bash
# Compare normalized outputs side-by-side
node scripts/normalize-json.js test/fixtures/golden/A-PROTEIN_PROD.expected.json > /tmp/golden.norm.json
node scripts/normalize-json.js <current-output.json> > /tmp/output.norm.json
diff -u /tmp/golden.norm.json /tmp/output.norm.json
```

### Fuzz Test Failure

Check `test/fixtures/failures/` for minimal reproducer:

```bash
ls -la test/fixtures/failures/
cat test/fixtures/failures/fuzz_*.fhx  # Examine failing input
```

### Test Hangs

- Check for infinite loops in `mutate()` or parser
- Use timeout: `npm run test -- --timeout 5000`

---

## Summary

The test infrastructure ties together:

- **Fixtures**: Input/output data (golden baselines + small snippets)
- **Helpers**: Shared functions (`normalizeSfc` for deterministic comparison)
- **Scripts**: CLI tools (update golden, compare, generate, fuzz)
- **Tests**: Mocha suites (unit + integration)

Together, they provide fast feedback during development while catching regressions via golden file comparison.
